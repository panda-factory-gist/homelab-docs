"use strict";(globalThis.webpackChunkhomelab_docs=globalThis.webpackChunkhomelab_docs||[]).push([[6823],{8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>d});var l=r(6540);const s={},i=l.createContext(s);function c(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),l.createElement(i.Provider,{value:n},e.children)}},8766:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>u,frontMatter:()=>c,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"homelab/infrastructure/cloudflare-tunnel","title":"Cloudflare Tunnel - Hermes","description":"Acc\xe8s distant s\xe9curis\xe9 sans port forwarding, nomm\xe9 d\'apr\xe8s Herm\xe8s, le messager des dieux.","source":"@site/docs/homelab/infrastructure/cloudflare-tunnel.md","sourceDirName":"homelab/infrastructure","slug":"/homelab/infrastructure/cloudflare-tunnel","permalink":"/docs/homelab/infrastructure/cloudflare-tunnel","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/homelab/infrastructure/cloudflare-tunnel.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"OPNsense - Olympus","permalink":"/docs/homelab/infrastructure/opnsense"},"next":{"title":"Architecture R\xe9seau","permalink":"/docs/homelab/infrastructure/network"}}');var s=r(4848),i=r(8453);const c={sidebar_position:4},d="Cloudflare Tunnel - Hermes",a={},t=[{value:"Concept",id:"concept",level:2},{value:"Architecture",id:"architecture",level:3},{value:"Avantages",id:"avantages",level:3},{value:"Infrastructure",id:"infrastructure",level:2},{value:"Container LXC",id:"container-lxc",level:3},{value:"Tunnel Cloudflare",id:"tunnel-cloudflare",level:3},{value:"Installation",id:"installation",level:2},{value:"\xc9tape 1 : Cr\xe9er le container",id:"\xe9tape-1--cr\xe9er-le-container",level:3},{value:"\xc9tape 2 : Installer cloudflared",id:"\xe9tape-2--installer-cloudflared",level:3},{value:"\xc9tape 3 : Se connecter \xe0 Cloudflare",id:"\xe9tape-3--se-connecter-\xe0-cloudflare",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Cr\xe9er les dossiers",id:"cr\xe9er-les-dossiers",level:3},{value:"Cr\xe9er la configuration",id:"cr\xe9er-la-configuration",level:3},{value:"R\xe9cup\xe9rer les credentials",id:"r\xe9cup\xe9rer-les-credentials",level:3},{value:"Service systemd",id:"service-systemd",level:2},{value:"Cr\xe9er le service",id:"cr\xe9er-le-service",level:3},{value:"Activer et d\xe9marrer",id:"activer-et-d\xe9marrer",level:3},{value:"Voir les logs",id:"voir-les-logs",level:3},{value:"DNS Configuration",id:"dns-configuration",level:2},{value:"Cloudflare Access (Zero Trust)",id:"cloudflare-access-zero-trust",level:2},{value:"Applications configur\xe9es",id:"applications-configur\xe9es",level:3},{value:"Cr\xe9er une application",id:"cr\xe9er-une-application",level:3},{value:"Session",id:"session",level:3},{value:"Acc\xe8s SSH via Cloudflare Tunnel",id:"acc\xe8s-ssh-via-cloudflare-tunnel",level:2},{value:"Sur Windows",id:"sur-windows",level:3},{value:"Installation cloudflared",id:"installation-cloudflared",level:4},{value:"Configuration SSH",id:"configuration-ssh",level:4},{value:"Utilisation",id:"utilisation",level:4},{value:"Ajouter un nouveau service",id:"ajouter-un-nouveau-service",level:2},{value:"Exemple : Ajouter GitLab",id:"exemple--ajouter-gitlab",level:3},{value:"1. Modifier la config du tunnel",id:"1-modifier-la-config-du-tunnel",level:4},{value:"2. Red\xe9marrer le service",id:"2-red\xe9marrer-le-service",level:4},{value:"3. Cr\xe9er le DNS record",id:"3-cr\xe9er-le-dns-record",level:4},{value:"4. Cr\xe9er l&#39;application Cloudflare Access",id:"4-cr\xe9er-lapplication-cloudflare-access",level:4},{value:"5. Tester",id:"5-tester",level:4},{value:"Backup",id:"backup",level:2},{value:"Fichiers critiques \xe0 sauvegarder",id:"fichiers-critiques-\xe0-sauvegarder",level:3},{value:"M\xe9thode de backup",id:"m\xe9thode-de-backup",level:3},{value:"Restauration",id:"restauration",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"V\xe9rifier l&#39;\xe9tat du tunnel",id:"v\xe9rifier-l\xe9tat-du-tunnel",level:3},{value:"Cloudflare Analytics",id:"cloudflare-analytics",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Tunnel ne d\xe9marre pas",id:"tunnel-ne-d\xe9marre-pas",level:3},{value:"Service ne se connecte pas",id:"service-ne-se-connecte-pas",level:3},{value:"Page inaccessible (Error 1033)",id:"page-inaccessible-error-1033",level:3},{value:"Authentification Cloudflare Access ne fonctionne pas",id:"authentification-cloudflare-access-ne-fonctionne-pas",level:3},{value:"S\xe9curit\xe9",id:"s\xe9curit\xe9",level:2},{value:"Best practices",id:"best-practices",level:3},{value:"Limitations",id:"limitations",level:3},{value:"Commandes utiles",id:"commandes-utiles",level:2},{value:"Ressources",id:"ressources",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"cloudflare-tunnel---hermes",children:"Cloudflare Tunnel - Hermes"})}),"\n",(0,s.jsx)(n.p,{children:"Acc\xe8s distant s\xe9curis\xe9 sans port forwarding, nomm\xe9 d'apr\xe8s Herm\xe8s, le messager des dieux."}),"\n",(0,s.jsx)(n.h2,{id:"concept",children:"Concept"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cloudflare Tunnel"})," cr\xe9e une connexion sortante chiffr\xe9e entre ton homelab et l'edge network de Cloudflare. Aucun port n'est ouvert sur ta box Internet."]}),"\n",(0,s.jsx)(n.h3,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Internet\n    \u2193\nCloudflare Edge Network\n    \u2193\nTunnel chiffr\xe9 (sortant uniquement)\n    \u2193\nContainer Hermes (CT 202)\n    \u2193\nServices internes (Proxmox, OPNsense)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"avantages",children:"Avantages"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Z\xe9ro port ouvert"})," sur la box Internet"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"IP publique cach\xe9e"})," - personne ne conna\xeet ton IP r\xe9elle"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Protection DDoS"})," gratuite"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Certificats SSL"})," automatiques"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Authentification"})," via Cloudflare Access"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Logs d'audit"})," complets"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Gratuit"})," pour usage personnel"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"infrastructure",children:"Infrastructure"}),"\n",(0,s.jsx)(n.h3,{id:"container-lxc",children:"Container LXC"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"ID"})," : 202"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Hostname"})," : hermes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"OS"})," : Ubuntu 24.04"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"RAM"})," : 256 MB"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CPU"})," : 1 core"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"R\xe9seau"})," : vmbr1 (LAN) - DHCP"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Service"})," : cloudflared (systemd)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"tunnel-cloudflare",children:"Tunnel Cloudflare"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tunnel ID"})," : ",(0,s.jsx)(n.code,{children:"[tunnel-uuid]"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tunnel Name"})," : opnsense-access"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Domaine"})," : [your-domain].org"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.h3,{id:"\xe9tape-1--cr\xe9er-le-container",children:"\xc9tape 1 : Cr\xe9er le container"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Sur Proxmox\npct create 202 \\\n  local:vztmpl/ubuntu-24.04-standard_24.04-2_amd64.tar.zst \\\n  --hostname hermes \\\n  --memory 256 \\\n  --cores 1 \\\n  --net0 name=eth0,bridge=vmbr1,ip=dhcp \\\n  --rootfs local-lvm:4 \\\n  --unprivileged 1 \\\n  --password\n\n# D\xe9marrer\npct start 202\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\xe9tape-2--installer-cloudflared",children:"\xc9tape 2 : Installer cloudflared"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Entrer dans le container\npct enter 202\n\n# Mise \xe0 jour\napt update && apt upgrade -y\n\n# Installer curl\napt install curl -y\n\n# T\xe9l\xe9charger cloudflared\ncurl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared\n\n# Rendre ex\xe9cutable\nchmod +x /usr/local/bin/cloudflared\n\n# V\xe9rifier\ncloudflared --version\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\xe9tape-3--se-connecter-\xe0-cloudflare",children:"\xc9tape 3 : Se connecter \xe0 Cloudflare"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Ajouter /usr/local/bin au PATH\nexport PATH=$PATH:/usr/local/bin\n\n# Login Cloudflare (ouvre un lien dans le navigateur)\ncloudflared tunnel login\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Copie le lien"})," affich\xe9, ouvre-le dans ton navigateur :"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Connecte-toi \xe0 Cloudflare"}),"\n",(0,s.jsxs)(n.li,{children:["S\xe9lectionne ",(0,s.jsx)(n.strong,{children:"[your-domain].org"})]}),"\n",(0,s.jsxs)(n.li,{children:["Clique ",(0,s.jsx)(n.strong,{children:"Authorize"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Un fichier ",(0,s.jsx)(n.code,{children:"cert.pem"})," est cr\xe9\xe9 dans ",(0,s.jsx)(n.code,{children:"/root/.cloudflared/"})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"cr\xe9er-les-dossiers",children:"Cr\xe9er les dossiers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Cr\xe9er le dossier de config\nmkdir -p /etc/cloudflared\n\n# Copier le certificat\ncp /root/.cloudflared/cert.pem /etc/cloudflared/\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cr\xe9er-la-configuration",children:"Cr\xe9er la configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nano /etc/cloudflared/config.yml\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contenu"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"tunnel: [tunnel-uuid]\ncredentials-file: /etc/cloudflared/[tunnel-uuid].json\n\ningress:\n  - hostname: opnsense.[your-domain].org\n    service: https://10.0.1.1\n    originServerName: 10.0.1.1\n    originRequest:\n      noTLSVerify: true\n  - hostname: proxmox.[your-domain].org\n    service: https://192.168.1.51:8006\n    originRequest:\n      noTLSVerify: true\n  - hostname: ssh-proxmox.[your-domain].org\n    service: ssh://192.168.1.51:22\n  - service: http_status:404\n"})}),"\n",(0,s.jsx)(n.h3,{id:"r\xe9cup\xe9rer-les-credentials",children:"R\xe9cup\xe9rer les credentials"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# T\xe9l\xe9charger les credentials du tunnel\ncloudflared tunnel token --cred-file /etc/cloudflared/f7fedba1-6be1-4408-a755-e9badd33f9a0.json f7fedba1-6be1-4408-a755-e9badd33f9a0\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"service-systemd",children:"Service systemd"}),"\n",(0,s.jsx)(n.h3,{id:"cr\xe9er-le-service",children:"Cr\xe9er le service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"nano /etc/systemd/system/cloudflared.service\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Contenu"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:"[Unit]\nDescription=Cloudflare Tunnel\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nExecStart=/usr/local/bin/cloudflared tunnel run opnsense-access\nRestart=on-failure\nRestartSec=5s\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,s.jsx)(n.h3,{id:"activer-et-d\xe9marrer",children:"Activer et d\xe9marrer"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Recharger systemd\nsystemctl daemon-reload\n\n# Activer au d\xe9marrage\nsystemctl enable cloudflared\n\n# D\xe9marrer\nsystemctl start cloudflared\n\n# V\xe9rifier le statut\nsystemctl status cloudflared\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Statut attendu"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u25cf cloudflared.service - Cloudflare Tunnel\n   Active: active (running)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"voir-les-logs",children:"Voir les logs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Logs en temps r\xe9el\njournalctl -u cloudflared -f\n\n# Derni\xe8res 50 lignes\njournalctl -u cloudflared -n 50\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Logs attendus"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Connection established to cftunnel.com\nConnection established to cftunnel.com\nConnection established to cftunnel.com\nConnection established to cftunnel.com\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"4 connexions = tunnel op\xe9rationnel"})," \u2705"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"dns-configuration",children:"DNS Configuration"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cloudflare Dashboard"})," \u2192 ",(0,s.jsx)(n.strong,{children:"DNS"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Records"})]}),"\n",(0,s.jsx)(n.p,{children:"Tous les enregistrements pointent vers le tunnel :"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Name"}),(0,s.jsx)(n.th,{children:"Target"}),(0,s.jsx)(n.th,{children:"Proxy"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"CNAME"}),(0,s.jsx)(n.td,{children:"opnsense"}),(0,s.jsx)(n.td,{children:"[tunnel-uuid].cfargotunnel.com"}),(0,s.jsx)(n.td,{children:"\u2601\ufe0f Proxied"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"CNAME"}),(0,s.jsx)(n.td,{children:"proxmox"}),(0,s.jsx)(n.td,{children:"[tunnel-uuid].cfargotunnel.com"}),(0,s.jsx)(n.td,{children:"\u2601\ufe0f Proxied"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"CNAME"}),(0,s.jsx)(n.td,{children:"ssh-proxmox"}),(0,s.jsx)(n.td,{children:"[tunnel-uuid].cfargotunnel.com"}),(0,s.jsx)(n.td,{children:"\u2601\ufe0f Proxied"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"CNAME"}),(0,s.jsx)(n.td,{children:"docs"}),(0,s.jsx)(n.td,{children:"[github-user].github.io"}),(0,s.jsx)(n.td,{children:"\u2601\ufe0f OFF"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cloudflare-access-zero-trust",children:"Cloudflare Access (Zero Trust)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Dashboard"})," : ",(0,s.jsx)(n.a,{href:"https://one.dash.cloudflare.com/",children:"https://one.dash.cloudflare.com/"})]}),"\n",(0,s.jsx)(n.h3,{id:"applications-configur\xe9es",children:"Applications configur\xe9es"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Application"}),(0,s.jsx)(n.th,{children:"URL"}),(0,s.jsx)(n.th,{children:"Policy"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"OPNsense Admin"}),(0,s.jsx)(n.td,{children:"opnsense.[your-domain].org"}),(0,s.jsx)(n.td,{children:"Email authentication"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Proxmox"}),(0,s.jsx)(n.td,{children:"proxmox.[your-domain].org"}),(0,s.jsx)(n.td,{children:"Email authentication"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SSH Proxmox"}),(0,s.jsx)(n.td,{children:"ssh-proxmox.[your-domain].org"}),(0,s.jsx)(n.td,{children:"Email authentication"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"cr\xe9er-une-application",children:"Cr\xe9er une application"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Access"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Applications"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Add an application"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Self-hosted"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Application name"})," : OPNsense Admin"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Session duration"})," : 24 hours"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Application domain"})," : opnsense.[your-domain].org"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Next"})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Policy"})," :"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Policy name"})," : Allow my email"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Action"})," : Allow"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Selector"})," : Emails"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Value"})," : ",(0,s.jsx)(n.a,{href:"mailto:ton-email@example.com",children:"ton-email@example.com"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Add policy"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Done"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"session",children:"Session"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dur\xe9e"})," : 24 heures (configurable)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authentification"})," : Via email (code OTP)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Premi\xe8re connexion"})," : Code envoy\xe9 par email"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Connexions suivantes"})," : Cookie de session"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"acc\xe8s-ssh-via-cloudflare-tunnel",children:"Acc\xe8s SSH via Cloudflare Tunnel"}),"\n",(0,s.jsx)(n.h3,{id:"sur-windows",children:"Sur Windows"}),"\n",(0,s.jsx)(n.h4,{id:"installation-cloudflared",children:"Installation cloudflared"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["T\xe9l\xe9charger : ",(0,s.jsx)(n.a,{href:"https://github.com/cloudflare/cloudflared/releases/latest",children:"https://github.com/cloudflare/cloudflared/releases/latest"})]}),"\n",(0,s.jsxs)(n.li,{children:["Fichier : ",(0,s.jsx)(n.code,{children:"cloudflared-windows-amd64.exe"})]}),"\n",(0,s.jsxs)(n.li,{children:["Placer dans : ",(0,s.jsx)(n.code,{children:"C:\\Program Files\\cloudflared\\cloudflared.exe"})]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"configuration-ssh",children:"Configuration SSH"}),"\n",(0,s.jsxs)(n.p,{children:["Cr\xe9er/\xe9diter ",(0,s.jsx)(n.code,{children:"C:\\Users\\[TON_USER]\\.ssh\\config"})," :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Host ssh-proxmox\n    HostName ssh-proxmox.[your-domain].org\n    User root\n    ProxyCommand C:\\PROGRA~1\\cloudflared\\cloudflared.exe access ssh --hostname ssh-proxmox.[your-domain].org\n"})}),"\n",(0,s.jsx)(n.h4,{id:"utilisation",children:"Utilisation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"ssh ssh-proxmox\n"})}),"\n",(0,s.jsx)(n.p,{children:"La premi\xe8re connexion ouvre le navigateur pour l'authentification Cloudflare Access."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"ajouter-un-nouveau-service",children:"Ajouter un nouveau service"}),"\n",(0,s.jsx)(n.h3,{id:"exemple--ajouter-gitlab",children:"Exemple : Ajouter GitLab"}),"\n",(0,s.jsx)(n.h4,{id:"1-modifier-la-config-du-tunnel",children:"1. Modifier la config du tunnel"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Dans le container hermes\npct enter 202\n\nnano /etc/cloudflared/config.yml\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ajouter"})," avant la derni\xe8re ligne :"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"  - hostname: gitlab.[your-domain].org\n    service: http://10.0.1.100:80\n"})}),"\n",(0,s.jsx)(n.h4,{id:"2-red\xe9marrer-le-service",children:"2. Red\xe9marrer le service"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"systemctl restart cloudflared\n\n# V\xe9rifier\njournalctl -u cloudflared -f\n"})}),"\n",(0,s.jsx)(n.h4,{id:"3-cr\xe9er-le-dns-record",children:"3. Cr\xe9er le DNS record"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cloudflared tunnel route dns opnsense-access gitlab.[your-domain].org\n"})}),"\n",(0,s.jsx)(n.p,{children:"Ou manuellement dans Cloudflare Dashboard :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Type : CNAME"}),"\n",(0,s.jsx)(n.li,{children:"Name : gitlab"}),"\n",(0,s.jsx)(n.li,{children:"Target : [tunnel-uuid]"}),"\n",(0,s.jsx)(n.li,{children:"Proxy : ON \u2601\ufe0f"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"4-cr\xe9er-lapplication-cloudflare-access",children:"4. Cr\xe9er l'application Cloudflare Access"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"https://one.dash.cloudflare.com/",children:"https://one.dash.cloudflare.com/"})})," \u2192 ",(0,s.jsx)(n.strong,{children:"Access"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Applications"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Add"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Application domain : gitlab.[your-domain].org"}),"\n",(0,s.jsx)(n.li,{children:"Policy : Allow ton email"}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"5-tester",children:"5. Tester"}),"\n",(0,s.jsx)(n.p,{children:"https: //gitlab.[your-domain].org"}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"backup",children:"Backup"}),"\n",(0,s.jsx)(n.h3,{id:"fichiers-critiques-\xe0-sauvegarder",children:"Fichiers critiques \xe0 sauvegarder"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Configuration\n/etc/cloudflared/config.yml\n\n# Credentials (TR\xc8S IMPORTANT - ne jamais perdre !)\n/etc/cloudflared/[tunnel-uuid].json\n\n# Certificat\n/etc/cloudflared/cert.pem\n"})}),"\n",(0,s.jsx)(n.h3,{id:"m\xe9thode-de-backup",children:"M\xe9thode de backup"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Depuis Proxmox\npct exec 202 -- tar czf /tmp/cloudflared-backup.tar.gz /etc/cloudflared\n\n# T\xe9l\xe9charger sur ton PC\npct pull 202 /tmp/cloudflared-backup.tar.gz ~/cloudflared-backup-$(date +%Y%m%d).tar.gz\n"})}),"\n",(0,s.jsx)(n.h3,{id:"restauration",children:"Restauration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Uploader le backup\npct push 202 ~/cloudflared-backup-YYYYMMDD.tar.gz /tmp/cloudflared-backup.tar.gz\n\n# Restaurer\npct exec 202 -- tar xzf /tmp/cloudflared-backup.tar.gz -C /\n\n# Red\xe9marrer le service\npct exec 202 -- systemctl restart cloudflared\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,s.jsx)(n.h3,{id:"v\xe9rifier-l\xe9tat-du-tunnel",children:"V\xe9rifier l'\xe9tat du tunnel"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Dans le container\npct enter 202\n\n# Statut du service\nsystemctl status cloudflared\n\n# Logs\njournalctl -u cloudflared -f\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Indicateurs de sant\xe9"})," :"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"4 connexions \xe9tablies \u2705"}),"\n",(0,s.jsx)(n.li,{children:"Aucune erreur dans les logs \u2705"}),"\n",(0,s.jsx)(n.li,{children:"Services accessibles via les URLs \u2705"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"cloudflare-analytics",children:"Cloudflare Analytics"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Dashboard"})," : ",(0,s.jsx)(n.a,{href:"https://one.dash.cloudflare.com/",children:"https://one.dash.cloudflare.com/"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Access"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Analytics"})," : Statistiques de connexion"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Logs"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Access"})," : Audit des authentifications"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Network"})," : Statistiques du tunnel"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"tunnel-ne-d\xe9marre-pas",children:"Tunnel ne d\xe9marre pas"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# V\xe9rifier la config YAML\nnano /etc/cloudflared/config.yml\n# V\xe9rifier l'indentation (espaces, pas de tabs)\n\n# Tester manuellement\nsystemctl stop cloudflared\ncloudflared tunnel run opnsense-access\n\n# Voir les erreurs d\xe9taill\xe9es\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Erreurs communes"})," :"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Indentation YAML incorrecte"}),"\n",(0,s.jsx)(n.li,{children:"Fichier credentials manquant"}),"\n",(0,s.jsx)(n.li,{children:"Tunnel ID incorrect"}),"\n",(0,s.jsx)(n.li,{children:"Chemin vers credentials-file incorrect"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"service-ne-se-connecte-pas",children:"Service ne se connecte pas"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# V\xe9rifier la connectivit\xe9 Internet du container\nping -c 3 1.1.1.1\nping -c 3 cloudflare.com\n\n# V\xe9rifier que OPNsense route correctement\n# Firewall \u2192 Log Files \u2192 Live View\n"})}),"\n",(0,s.jsx)(n.h3,{id:"page-inaccessible-error-1033",children:"Page inaccessible (Error 1033)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"})," : Le tunnel n'est pas connect\xe9"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution"})," :"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["V\xe9rifier que le container est d\xe9marr\xe9 : ",(0,s.jsx)(n.code,{children:"pct status 202"})]}),"\n",(0,s.jsxs)(n.li,{children:["V\xe9rifier que le service tourne : ",(0,s.jsx)(n.code,{children:"pct exec 202 -- systemctl status cloudflared"})]}),"\n",(0,s.jsxs)(n.li,{children:["Red\xe9marrer si n\xe9cessaire : ",(0,s.jsx)(n.code,{children:"pct exec 202 -- systemctl restart cloudflared"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"authentification-cloudflare-access-ne-fonctionne-pas",children:"Authentification Cloudflare Access ne fonctionne pas"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"V\xe9rifier que l'application existe dans le dashboard"}),"\n",(0,s.jsx)(n.li,{children:"V\xe9rifier la policy (email correct)"}),"\n",(0,s.jsx)(n.li,{children:"Essayer en navigation priv\xe9e"}),"\n",(0,s.jsx)(n.li,{children:"V\xe9rifier les logs Access dans le dashboard"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"s\xe9curit\xe9",children:"S\xe9curit\xe9"}),"\n",(0,s.jsx)(n.h3,{id:"best-practices",children:"Best practices"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Backup r\xe9gulier"})," du dossier ",(0,s.jsx)(n.code,{children:"/etc/cloudflared/"})]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Authentification forte"})," (email + 2FA Cloudflare)"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Policies restrictives"})," (whitelist emails uniquement)"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Monitoring des logs"})," Access"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Session courte"})," (24h max)"]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Firewall rules"})," pour restreindre l'acc\xe8s au container"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Latence"})," : +10-50ms due au passage par Cloudflare Edge"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Protocoles"})," : HTTP/HTTPS/SSH uniquement (pas de RDP direct)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Bande passante"})," : Limit\xe9e par le plan gratuit (suffisant pour homelab)"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"commandes-utiles",children:"Commandes utiles"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Lister les tunnels\ncloudflared tunnel list\n\n# Info sur le tunnel\ncloudflared tunnel info opnsense-access\n\n# Cr\xe9er un nouveau tunnel\ncloudflared tunnel create nom-tunnel\n\n# Supprimer un tunnel\ncloudflared tunnel delete nom-tunnel\n\n# Cr\xe9er une route DNS\ncloudflared tunnel route dns opnsense-access subdomain.[your-domain].org\n\n# Lister les routes\ncloudflared tunnel route dns list\n\n# Tester la config\ncloudflared tunnel ingress validate\n\n# Tester un hostname sp\xe9cifique\ncloudflared tunnel ingress rule https://proxmox.[your-domain].org\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"ressources",children:"Ressources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Documentation officielle"})," : ",(0,s.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/",children:"https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cloudflare Access"})," : ",(0,s.jsx)(n.a,{href:"https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/",children:"https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"GitHub cloudflared"})," : ",(0,s.jsx)(n.a,{href:"https://github.com/cloudflare/cloudflared",children:"https://github.com/cloudflare/cloudflared"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Dashboard"})," : ",(0,s.jsx)(n.a,{href:"https://one.dash.cloudflare.com/",children:"https://one.dash.cloudflare.com/"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);